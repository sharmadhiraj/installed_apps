name: Verify Plugin Build

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: "Which flutter & kotlin versions to run"
        required: true
        default: "full matrix (latest 5x5)"
        type: choice
        options:
          - full matrix (latest 5x5)
          - latest only
      platform:
        description: "Runner OS platform"
        required: true
        default: "ubuntu"
        type: choice
        options:
          - ubuntu
          - windows
          - macos

jobs:

  verify-plugin:
    needs: fetch-versions
    runs-on: ${{ github.event.inputs.platform == 'windows' && 'windows-latest' || github.event.inputs.platform == 'macos' && 'macos-latest' || 'ubuntu-latest' }}
    strategy:
      matrix:
        flutter-version: ${{ fromJson(needs.fetch-versions.outputs.flutter_versions) }}
        kotlin-version: ${{ fromJson(needs.fetch-versions.outputs.kotlin_versions) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: false

      - name: Accept Android licenses
        shell: bash
        run: yes | flutter doctor --android-licenses

      - name: Set Kotlin version
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            pwsh -Command "(Get-Content example/android/settings.gradle) -replace 'id \"org.jetbrains.kotlin.android\" version \".*\"', 'id \"org.jetbrains.kotlin.android\" version \"${{ matrix.kotlin-version }}\"' | Set-Content example/android/settings.gradle"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' "s/id \"org.jetbrains.kotlin.android\" version \".*\"/id \"org.jetbrains.kotlin.android\" version \"${{ matrix.kotlin-version }}\"/" example/android/settings.gradle
          else
            sed -i "s/id \"org.jetbrains.kotlin.android\" version \".*\"/id \"org.jetbrains.kotlin.android\" version \"${{ matrix.kotlin-version }}\"/" example/android/settings.gradle
          fi

      - name: Get example dependencies
        working-directory: example
        run: flutter pub get

      - name: Build example APK
        working-directory: example
        run: flutter build apk --debug --no-tree-shake-icons
        env:
          GRADLE_OPTS: "-Xmx4g"

  fetch-versions:
    runs-on: ubuntu-latest
    outputs:
      flutter_versions: ${{ steps.set-flutter.outputs.versions }}
      kotlin_versions: ${{ steps.set-kotlin.outputs.versions }}
    steps:
      - name: Fetch Flutter Versions
        id: set-flutter
        run: |
          case "${{ github.event.inputs.platform }}" in
            ubuntu) FLUTTER_JSON="releases_linux.json" ;;
            windows) FLUTTER_JSON="releases_windows.json" ;;
            macos) FLUTTER_JSON="releases_macos.json" ;;
          esac
          
          SLICE=5
          if [ "${{ github.event.inputs.run_mode }}" == "latest only" ]; then
            SLICE=1
          fi
          
          VERSIONS=$(curl -s https://storage.googleapis.com/flutter_infra_release/releases/$FLUTTER_JSON | \
            jq -c --arg slice "$SLICE" '
              .releases
              | reduce .[] as $r (
                  {seen: [], out: []};
                  if ($r.channel == "stable")
                     and ($r.version | test("^[v]?[0-9]+\\.[0-9]+\\.[0-9]+"))
                  then
                    ($r.version | sub("^v"; "") | capture("(?<mm>[0-9]+\\.[0-9]+)")) as $v
                    | if (.seen | index($v.mm)) then .
                      else
                        .seen += [$v.mm]
                        | .out += [$r.version | sub("^v"; "")]
                      end
                  else .
                  end
                )
              | .out[0:($slice|tonumber)]
            ')
          echo "Fetched Flutter Versions: $VERSIONS"
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

      - name: Fetch Kotlin Versions
        id: set-kotlin
        run: |
          SLICE=5
          if [ "${{ github.event.inputs.run_mode }}" == "latest only" ]; then
            SLICE=1
          fi
          VERSIONS=$(curl -s https://endoflife.date/api/v1/products/kotlin/ | \
            jq -c --arg slice "$SLICE" '
              .result.releases
              | reduce .[] as $r (
                  {seen: [], out: []};
                  ($r.latest.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+")) as $ok
                  | if $ok then
                      ($r.latest.name | capture("(?<mm>[0-9]+\\.[0-9]+)")) as $v
                      | if (.seen | index($v.mm)) then .
                        else
                          .seen += [$v.mm]
                          | .out += [$r.latest.name]
                        end
                    else .
                    end
                )
              | .out[0:($slice|tonumber)]
            ')
          echo "Fetched Kotlin Versions: $VERSIONS"
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
